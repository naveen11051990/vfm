---
- name: Audit PAN‑OS firewall — check RBAC usage for admin accounts
  hosts: "PRODUCTIONFIREWALL"
  connection: local
  gather_facts: no

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Retrieve full config XML from firewall
      paloaltonetworks.panos.panos_facts:
        provider: "{{ device }}"
        gather_subset:
          - config
      register: pan_cfg

    - name: Extract admin‑users portion of config XML
      set_fact:
        admin_users_xml: >-
          {{
            pan_cfg.ansible_net_config
            | regex_search('(?s)<mgt-config>.*?<users>.*?</users>.*?</mgt-config>')
            | default('')
          }}

    - name: Fail if unable to fetch admin users config
      ansible.builtin.assert:
        that:
          - admin_users_xml | length > 0
        fail_msg: "Could not find admin‑users configuration in firewall config — RBAC config fetch failed or no admin accounts defined."

    - name: Parse admin accounts and permissions into list
      set_fact:
        admin_accounts: >-
          {{
            (admin_users_xml
             | regex_findall('(?s)<entry name="([^"]+)".*?<role‑based>.*?</role‑based>.*?</entry>')
            ) | list
          }}

    - name: Warn about accounts not using role‑based privileges
      ansible.builtin.debug:
        msg: |
          WARNING: The following admin accounts do not use role‑based privileges and might have default/full access:
          {%- for entry in (admin_users_xml | regex_findall('(?s)<entry name="([^"]+)".*?(?:(?!<role‑based>).)*?</entry>')) %}
            - {{ entry }}
          {%- endfor %}
      when: (admin_users_xml | regex_search('(?s)<entry name="([^"]+)".*?(?:(?!<role‑based>).)*?</entry>')) is not none

    - name: Report compliance status
      ansible.builtin.debug:
        msg: |
          RBAC audit result:
            - Admin accounts using role‑based privileges: {{ admin_accounts }}
            - Total admin accounts found: {{ (admin_users_xml | regex_findall('(?s)<entry name="([^"]+)".*?</entry>')) | length }}
