---
- name: Audit PAN-OS firewall — management interface service audit
  hosts: "PRODUCTIONFIREWALL"
  connection: local
  gather_facts: no

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Fetch system/service configuration via config-API
      paloaltonetworks.panos.panos_config_element:
        provider: "{{ device }}"
        xpath: /config/devices/entry[@name="localhost.localdomain"]/deviceconfig/system/service
        state: gathered
      register: svc_cfg

    - name: Debug — show service config XML
      ansible.builtin.debug:
        msg: |
          Retrieved service configuration:
          {{ svc_cfg.element | default('') }}

    - name: Check management-interface services — flag if HTTP or Telnet enabled
      ansible.builtin.assert:
        that:
          # check that HTTP and Telnet are disabled
          - "'<disable-http>yes</disable-http>' in svc_cfg.element"
          - "'<disable-telnet>yes</disable-telnet>' in svc_cfg.element"
        fail_msg: |
          management_interface_services_non-compliance:
          HTTP and/or Telnet appear enabled on management interface!
          Current config snapshot:
          {{ svc_cfg.element | default('') }}

    - name: PASS — management interface services seem secure
      ansible.builtin.debug:
        msg: "OK — Management-interface services appear compliant (HTTP & Telnet disabled)."
