---
- name: Detect unused security policies on PAN-OS firewall
  hosts: PRODUCTIONFIREWALL     # update per your inventory
  connection: local
  gather_facts: false

  vars:
    provider:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
      # port: 443 # optional

    vsys_name: "vsys1"   # change if your firewall uses a different VSYS

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Fetch rule hit-count for all security rules
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: |
          <show>
            <rule-hit-count>
              <vsys>
                <vsys-name>
                  <entry name='{{ vsys_name }}'>
                    <rule-base>
                      <entry name='security'>
                        <rules>
                          <all/>
                        </rules>
                      </entry>
                    </rule-base>
                  </entry>
                </vsys-name>
              </vsys>
            </rule-hit-count>
          </show>
      register: hitcount_raw
      failed_when: false

    - name: Convert XML output to dict
      ansible.builtin.set_fact:
        hitcount_struct: "{{ hitcount_raw.stdout | ansible.utils.from_xml }}"

    - name: Extract rules with zero hit count
      ansible.builtin.set_fact:
        unused_rules: >-
          {{
            hitcount_struct.response.result['rule-hit-count'].vsys.entry
            | map(attribute='entry.rule-base.entry.security.rules.entry')
            | flatten
            | selectattr('hit-count','equalto','0')
            | map(attribute='@name')
            | list
          }}

    - name: Report unused security rules
      ansible.builtin.debug:
        msg: |
          Unused security rules (zero hits) in VSYS "{{ vsys_name }}":
          {% if unused_rules %}
            {% for r in unused_rules %}
            - {{ r }}
            {% endfor %}
          {% else %}
            No unused rules found (or no hit-count data available).
          {% endif %}
