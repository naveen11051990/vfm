---
- name: Detect unused security policies on PAN-OS firewall
  hosts: PRODUCTIONFIREWALL     # adjust as per your inventory
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
      # port: 443  # optional if default

    vsys_name: "vsys1"   # Change to your VSYS if different

  collections:
    - paloaltonetworks.panos

  pre_tasks:
    - name: Check if ansible.utils.from_xml filter is available
      ansible.builtin.assert:
        that:
          - "'ansible.utils' in ansible_facts.collections | map(attribute='namespace') | list"
        fail_msg: >-
          The ansible.utils collection is required for XML parsing but is not installed.
          Please run:
            ansible-galaxy collection install ansible.utils
          Then retry this playbook.
        success_msg: "Required collection ansible.utils is installed."

  tasks:
    - name: Fetch rule hit-count for all security rules
      paloaltonetworks.panos.panos_op:
        provider: "{{ provider }}"
        cmd: |
          <show>
            <rule-hit-count>
              <vsys>
                <vsys-name>
                  <entry name='{{ vsys_name }}'>
                    <rule-base>
                      <entry name='security'>
                        <rules>
                          <all/>
                        </rules>
                      </entry>
                    </rule-base>
                  </entry>
                </vsys-name>
              </vsys>
            </rule-hit-count>
          </show>
      register: hitcount_raw
      failed_when: false

    - name: Convert XML output to dict
      ansible.builtin.set_fact:
        hitcount_struct: "{{ hitcount_raw.stdout | ansible.utils.from_xml }}"

    - name: Extract rules with zero hit count
      ansible.builtin.set_fact:
        unused_rules: >-
          {{
            hitcount_struct.response.result['rule-hit-count'].vsys.entry
            | selectattr('entry.rule-base.entry.security.rules.entry', 'defined')
            | map(attribute='entry.rule-base.entry.security.rules.entry')
            | sum(start=[])
            | selectattr('hit-count','equalto','0')
            | map(attribute='@name')
            | list
          }}

    - name: Report unused security rules
      ansible.builtin.debug:
        msg: |
          Unused security rules (zero hits) in VSYS "{{ vsys_name }}":
          {% if unused_rules %}
            {% for r in unused_rules %}
            - {{ r }}
            {% endfor %}
          {% else %}
            No unused rules found (all rules have hit-count > 0 or no hit-count data).
          {% endif %}
