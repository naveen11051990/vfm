---
- name: Detect unused security policies on PAN-OS firewall (defensive)
  hosts: PRODUCTIONFIREWALL
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
    vsys_name: "vsys1"

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Fetch rule hit-count for all security rules
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: |
          <show>
            <rule-hit-count>
              <vsys>
                <vsys-name>
                  <entry name='{{ vsys_name }}'>
                    <rule-base>
                      <entry name='security'>
                        <rules>
                          <all/>
                        </rules>
                      </entry>
                    </rule-base>
                  </entry>
                </vsys-name>
              </vsys>
            </rule-hit-count>
          </show>
      register: hitcount_raw
      failed_when: false

    - name: Check for returned data
      ansible.builtin.debug:
        msg: >
          raw result keys: {{ hitcount_raw.keys() | list }}

    - name: Set parsed_hitcount based on available output
      ansible.builtin.set_fact:
        parsed_hitcount: >-
          {%- if hitcount_raw.stdout_xml is defined and hitcount_raw.stdout_xml | length > 0 -%}
            {{ hitcount_raw.stdout_xml | ansible.utils.from_xml }}
          {%- elif hitcount_raw.stdout is defined and hitcount_raw.stdout | length > 0 -%}
            {{ hitcount_raw.stdout | from_json }}
          {%- else -%}
            {}
          {%- endif -%}

    - name: Determine unused rules if hit-count data present
      ansible.builtin.set_fact:
        unused_rules: >-
          {%- if parsed_hitcount.response is defined and parsed_hitcount.response.result is defined -%}
            {{
              parsed_hitcount.response.result['rule-hit-count'].vsys.entry
              | map(attribute='entry.rule-base.entry.security.rules.entry')
              | flatten
              | selectattr('hit-count','equalto','0')
              | map(attribute='@name')
              | list
            }}
          {%- else -%}
            []
          {%- endif -%}

    - name: Report unused security rules (or warning if no data)
      ansible.builtin.debug:
        msg: >-
          {% if unused_rules %}
            Unused security rules (hit-count = 0): {{ unused_rules }}
          {% else %}
            {% if parsed_hitcount == {} %}
              WARNING: No hit-count data returned â€” cannot determine unused rules.
            {% else %}
              No unused rules found (or hit-count data present, but all > 0).
            {% endif %}
          {% endif %}
