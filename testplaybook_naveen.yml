---
- name: Check for security rules missing required security profiles
  hosts: PRODUCTIONFIREWALL   # change to your inventory group or host
  connection: local
  gather_facts: false

  vars:
    provider:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
    # List of profile-fields to enforce
    required_profiles:
      - group_profile
      - antivirus
      - vulnerability
      - spyware
      - url_filtering
      - file_blocking

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Gather all security rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ device }}"
        state: gathered
        gathered_filter: "*"              # â† mandatory to gather all rules 
      register: sec_rules

    - name: Filter rules missing one or more required profiles
      set_fact:
        rules_missing_profiles: >-
          {{
            sec_rules.rules
            | select(
                lambda r:
                  (
                    (r.group_profile | default('')_
