---
- name: Detect unused security policies on PAN-OS firewall
  hosts: PRODUCTIONFIREWALL     # adjust per your inventory / host group
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
      # port: 443   # optional if default

    vsys_name: "vsys1"   # change if your firewall uses a different vsys

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Fetch rule hit-count for all security rules
      paloaltonetworks.panos.panos_op:
        provider: "{{ device }}"
        cmd: |
          <show>
            <rule-hit-count>
              <vsys>
                <vsys-name>
                  <entry name='{{ vsys_name }}'>
                    <rule-base>
                      <entry name='security'>
                        <rules>
                          <all/>
                        </rules>
                      </entry>
                    </rule-base>
                  </entry>
                </vsys-name>
              </vsys>
            </rule-hit-count>
          </show>
      register: hitcount_raw
      failed_when: false

    - name: Parse hit-count XML output
      ansible.builtin.set_fact:
        hitcount_struct: "{{ hitcount_raw.stdout | from_xml }}"

    - name: Extract unused rules (zero hits)
      ansible.builtin.set_fact:
        unused_rules: >-
          {{
            hitcount_struct.response.result['rule-hit-count'].vsys.entry.rule-base.entry.security.rules.entry
            | rejectattr('hit-count','int')
            | selectattr('hit-count','equalto','0')
            | map(attribute='@name')
            | list
          }}

    - name: Display unused security rules
      ansible.builtin.debug:
        msg: |
          Unused security rules (hit-count = 0) in {{ vsys_name }}:
          {% if unused_rules %}
            {% for r in unused_rules %}
            - {{ r }}
            {% endfor %}
          {% else %}
            No rules with zero hit count found.
          {% endif %}
