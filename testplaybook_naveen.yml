---
- name: Detect security rules missing required security profiles
  hosts: PRODUCTIONFIREWALL   # replace with your inventory group or host
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"
    # List of profile-fields you consider mandatory
    required_profiles:
      - group_profile
      - antivirus
      - vulnerability
      - spyware
      - url_filtering
      - file_blocking

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Gather all security rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ device }}"
        state: gathered
        gathered_filter: "*"       # wildcard to fetch all rules :contentReference[oaicite:2]{index=2}
      register: sec_rules

    - name: Debug â€” dump what was returned for inspection
      ansible.builtin.debug:
        var: sec_rules

    - name: Initialize list for non-compliant rules
      ansible.builtin.set_fact:
        rules_missing_profiles: []

    - name: Identify rules missing one or more required profiles
      loop: "{{ sec_rules.gathered }}"
      vars:
        r: "{{ item }}"
      when: >
        (r.group_profile   | default('') | length == 0) or
        (r.antivirus       | default('') | length == 0) or
        (r.vulnerability   | default('') | length == 0) or
        (r.spyware         | default('') | length == 0) or
        (r.url_filtering   | default('') | length == 0) or
        (r.file_blocking   | default('') | length == 0)
      set_fact:
        rules_missing_profiles: "{{ rules_missing_profiles + [ r ] }}"

    - name: Report rules missing required profile(s)
      ansible.builtin.debug:
        msg: |
          Security rules missing required profiles:
          {% if rules_missing_profiles %}
            {% for r in rules_missing_profiles %}
            - {{ r.rule_name | de_
