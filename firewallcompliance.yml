---
- name: Find security rules without description
  hosts: "{{ hosts | default('PRODUCTIONFIREWALL') }}"
  connection: local
  gather_facts: no

  vars:
    device:
      ip_address: "{{ ip_address }}"
      username: "{{ username }}"
      password: "{{ password }}"

  collections:
    - paloaltonetworks.panos

  tasks:
    - name: Gather all security rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ device }}"
        state: gathered
        gathered_filter: "*"  # fetch all rules :contentReference[oaicite:0]{index=0}
      register: sec_rules


    - name: Filter any-any insecure rules (source=any, dest=any, service=any)
      ansible.builtin.set_fact:
        any_any_insecure_rules: >-
          {{
            (sec_rules.gathered | default([]))
            | selectattr('source_ip', 'equalto', ['any'])
            | selectattr('destination_ip', 'equalto', ['any'])
            | selectattr('service', 'equalto', ['any'])
            | selectattr('source_zone', 'equalto', ['any'])
            | selectattr('destination_zone', 'equalto', ['any'])
            | list
          }}


    - name: Filter rules missing description
      ansible.builtin.set_fact:
        rules_missing_description: >-
          {{
            (sec_rules.gathered | default([]))
            | selectattr('description', 'equalto', None)
            | list
          }}

    - name: Filter rules that use specific source_user (i.e. not 'any')
      ansible.builtin.set_fact:
        user_based_rules: >-
          {{
            (sec_rules.gathered | default([]))
            | selectattr('source_user', 'defined')
            | rejectattr('source_user', 'equalto', ['any'])
            | list
          }}

    - name: Get all decryption rules
      paloaltonetworks.panos.panos_decryption_rule:
        provider: "{{ device }}"
        state: gathered
        gathered_filter: "*"
      register: decryption_rules

    - name: Filter rules where action = decrypt (or decrypt-and-forward)
      set_fact:
         decrypt_rules: >-
          {{
            (decryption_rules.decryption_rules | default([]))
            | selectattr('action', 'in', ['decrypt','decrypt-and-forward'])
            | list
          }}

    - name: Debug decrypt rules
      debug:
        msg: |
          Decryption rules with action decrypt:
          {% for rule in decrypt_rules %}
            - {{ rule.name }} → action: {{ rule.action }}, decryption_type: {{ rule.decryption_type }}
          {% else %}
            (No decrypt rules found)
          {% endfor %}

    - name: Filter rules missing *all* security profiles
      set_fact:
        unprotected_rules: >-
          {{
            (sec_rules.gathered | default([]))
            | selectattr('antivirus', 'equalto', None)
            | selectattr('vulnerability', 'equalto', None)
            | selectattr('spyware', 'equalto', None)
            | selectattr('url_filtering', 'equalto', None)
            | selectattr('file_blocking', 'equalto', None)
            | list
          }}

    - name: Print rules without description
      ansible.builtin.debug:
        msg: |
          The following security rules are missing a description and audit comment:
          {% for rule in rules_missing_description %}
            - {{ rule.rule_name | default(rule.name) }}
          {% else %}
            (None found)
          {% endfor %}



    - name: Print insecure any-any rules
      ansible.builtin.debug:
        msg: |
          Insecure any-any rules (source=any, dest=any, service=any):
          {% for rule in any_any_insecure_rules %}
            - {{ rule.rule_name | default(rule.name) }}
          {% else %}
            (None found)
          {% endfor %}


    - name: Print rules that are user-based
      ansible.builtin.debug:
        msg: |
          The following security rules are using source_user (User-ID):
          {% for rule in user_based_rules %}
            - {{ rule.rule_name | default(rule.name) }} → source_user: {{ rule.source_user }}
          {% else %}
            (No user-based security rules found)
          {% endfor %}

    - name: Debug decrypt rules
      debug:
        msg: |
          Decryption rules with action decrypt:
          {% for rule in decrypt_rules %}
            - {{ rule.name }} → action: {{ rule.action }}, decryption_type: {{ rule.decryption_type }}
          {% else %}
            (No decrypt rules found)
          {% endfor %}


    - name: Show rules that do not have any security profile set
      debug:
        msg: |
          The following security rules are *not* protected by any security profile:
          {% for rule in unprotected_rules %}
            - {{ rule.rule_name | default(rule.name) }}
          {% else %}
            (None found)
          {% endfor %}
