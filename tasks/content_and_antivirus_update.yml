- name: Ensure device is ready before content upgrade
  paloaltonetworks.panos.panos_check:
    provider: "{{ device }}"
  register: ready_check
  until: ready_check is not failed and ready_check.msg == 'Device is ready.'
  retries: 10
  delay: 10

- name: Install latest content update via official module
  paloaltonetworks.panos.panos_dynamic_updates:
    provider: "{{ device }}"
    update_type: content
    sync_to_peer: true
  register: content_update

- name: Wait for device readiness after content install
  paloaltonetworks.panos.panos_check:
    provider: "{{ device }}"
  register: ready_after_content
  until: ready_after_content is not failed and ready_after_content.msg == 'Device is ready.'
  retries: 60
  delay: 15
  no_log: true

- name: Install latest anti-virus update via official module
  paloaltonetworks.panos.panos_dynamic_updates:
    provider: "{{ device }}"
    update_type: anti-virus
    sync_to_peer: true
  register: antivirus_update

- name: Wait for device readiness after anti-virus install
  paloaltonetworks.panos.panos_check:
    provider: "{{ device }}"
  register: ready_after_antivirus
  until: ready_after_antivirus is not failed and ready_after_antivirus.msg == 'Device is ready.'
  retries: 60
  delay: 15
  no_log: true

- name: Cache antivirus version fact
  ansible.builtin.set_fact:
    ha_antivirus_version: "{{ antivirus_update.anti_virus | default('unknown') }}"
