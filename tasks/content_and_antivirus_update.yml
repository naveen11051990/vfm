---
# Content and Antivirus Update Tasks
# Uses panos_op for content/antivirus operations (no panos_software module alternative available)
# Manual job polling is documented limitation due to lack of dedicated job tracking module

- name: Ensure device is ready before content upgrade
  paloaltonetworks.panos.panos_check:
    provider: "{{ device }}"
  register: ready_check
  until: ready_check is not failed
  retries: 10
  delay: 10

- name: Refresh content update index
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request content upgrade check"

- name: Download latest content update
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request content upgrade download latest"
  register: content_download

# NOTE: Manual job ID extraction needed because panos_software does not support content updates
# panos_op output contains job ID in XML, extracted via regex
- name: Extract job ID for content download
  ansible.builtin.set_fact:
    content_download_jobid: "{{ content_download.stdout_xml | default('') | regex_search('<job>(\\d+)</job>', '\\1') | first | default('') }}"

- name: Wait for content download job to complete
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request job info id {{ content_download_jobid }}"
  register: content_download_result
  until: content_download_result.stdout_xml is search('<status>FIN</status>')
  retries: 300
  delay: 10
  failed_when: content_download_result.stdout_xml is search('<result>FAIL</result>')
  when: content_download_jobid | length > 0
  no_log: true

- name: Install latest content update
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request content upgrade install version latest"
  register: content_install

# NOTE: Manual job ID extraction - see content download note
- name: Extract job ID for content install
  ansible.builtin.set_fact:
    content_install_jobid: "{{ content_install.stdout_xml | default('') | regex_search('<job>(\\d+)</job>', '\\1') | first | default('') }}"

- name: Wait for content install job to complete
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request job info id {{ content_install_jobid }}"
  register: content_install_result
  until: >
    content_install_result.stdout_xml is search('<status>FIN</status>') or
    content_install_result.stdout_xml is search('<status>FAIL</status>')
  retries: 300
  delay: 10
  failed_when: >
    (content_install_result.stdout_xml is search('<status>FIN</status>') and
     content_install_result.stdout_xml is search('<result>FAIL</result>')) or
    content_install_result.stdout_xml is search('<status>FAIL</status>')
  when: content_install_jobid | length > 0
  no_log: true

- name: Wait for device readiness after content install
  paloaltonetworks.panos.panos_check:
    provider: "{{ device }}"
  register: ready_after_content
  until: ready_after_content is not failed
  retries: 60
  delay: 15
  no_log: true

- name: Refresh antivirus update index
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request anti-virus upgrade check"

- name: Download latest antivirus update
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request anti-virus upgrade download latest"
  register: antivirus_download

# NOTE: Manual job ID extraction - see content download note
- name: Extract job ID for antivirus download
  ansible.builtin.set_fact:
    antivirus_download_jobid: "{{ antivirus_download.stdout_xml | default('') | regex_search('<job>(\\d+)</job>', '\\1') | first | default('') }}"

- name: Wait for antivirus download job to complete
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request job info id {{ antivirus_download_jobid }}"
  register: antivirus_download_result
  until: antivirus_download_result.stdout_xml is search('<status>FIN</status>')
  retries: 300
  delay: 10
  failed_when: antivirus_download_result.stdout_xml is search('<result>FAIL</result>')
  when: antivirus_download_jobid | length > 0
  no_log: true

- name: Install latest antivirus update
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request anti-virus upgrade install version latest"
  register: antivirus_install

# NOTE: Manual job ID extraction - see content download note
- name: Extract job ID for antivirus install
  ansible.builtin.set_fact:
    antivirus_install_jobid: "{{ antivirus_install.stdout_xml | default('') | regex_search('<job>(\\d+)</job>', '\\1') | first | default('') }}"

- name: Wait for antivirus install job to complete
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request job info id {{ antivirus_install_jobid }}"
  register: antivirus_install_result
  until: >
    antivirus_install_result.stdout_xml is search('<status>FIN</status>') or
    antivirus_install_result.stdout_xml is search('<status>FAIL</status>')
  retries: 300
  delay: 10
  failed_when: >
    (antivirus_install_result.stdout_xml is search('<status>FIN</status>') and
     antivirus_install_result.stdout_xml is search('<result>FAIL</result>')) or
    antivirus_install_result.stdout_xml is search('<status>FAIL</status>')
  when: antivirus_install_jobid | length > 0
  no_log: true

- name: Query installed antivirus package information
  paloaltonetworks.panos.panos_op:
    provider: "{{ device }}"
    cmd: "request anti-virus upgrade info"
  register: antivirus_info_raw

# NOTE: Extract current antivirus version from info output
# Used for HA peer verification (both nodes must have same antivirus version before upgrade)
- name: Cache antivirus version fact
  ansible.builtin.set_fact:
    ha_antivirus_version: >-
      {{ (antivirus_info_raw.stdout_xml | default(''))
          | regex_findall('(?s)<entry>.*?<version>([^<]+)</version>.*?<current>yes</current>.*?</entry>')
          | first | default('unknown') }}
