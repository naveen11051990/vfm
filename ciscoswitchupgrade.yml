---
- name: Upgrade Cisco Catalyst 9300 Switch IOS-XE
  hosts: 192.168.29.164
  gather_facts: no
  connection: network_cli

  vars:
    new_image: "cat9k_iosxe.17.15.03.SPA.bin"
    tftp_server: "192.168.29.63"
    image_path: "flash:{{ new_image }}"
    boot_system_cmd: "boot system flash:{{ new_image }}"
    mgmt_vrf: "Mgmt-vrf"
    # Number of retries for long-running IOS commands
    cmd_retries: 60
    cmd_interval: 10

  tasks:
    - name: Check connectivity to TFTP server (via Mgmt VRF)
      cisco.ios.ios_command:
        commands:
          - "ping vrf {{ mgmt_vrf }} {{ tftp_server }} repeat 5"
        wait_for:
          - "result[0] contains Success rate"
        retries: "{{ cmd_retries }}"
        interval: "{{ cmd_interval }}"
      register: ping_result

    - name: Display ping result
      debug:
        var: ping_result.stdout_lines

    - name: Verify flash space
      cisco.ios.ios_command:
        commands:
          - "show flash: | include bytes"
      register: flash_space

    - name: Display flash space
      debug:
        var: flash_space.stdout_lines

    - name: Copy image from TFTP to switch flash
      cisco.ios.ios_command:
        commands:
          - command: "copy tftp://{{ tftp_server }}/{{ new_image }} flash:"
            prompt:
              - "Address or name of remote host.*\\?"  
              - "Source filename \\[{{ new_image }}\\]\\?"  
              - "Destination filename \\[{{ new_image }}\\]\\?"  
            answer:
              - "{{ tftp_server }}"
              - "{{ new_image }}"
              - "{{ new_image }}"
        wait_for:
          - "result[0] contains bytes"    # adjust based on the real copy output
        retries: "{{ cmd_retries }}"
        interval: "{{ cmd_interval }}"
      register: tftp_copy

    - name: Debug copy result
      debug:
        msg: "{{ tftp_copy.stdout_lines }}"

    - name: Set boot variable to new image
      cisco.ios.ios_command:
        commands:
          - "configure terminal"
          - "no boot system"
          - "{{ boot_system_cmd }}"
          - "end"
          - "write memory"
      register: boot_out

    - name: Debug boot config output
      debug:
        msg: "{{ boot_out.stdout_lines }}"

    - name: Reload the switch to activate new image
      cisco.ios.ios_command:
        commands:
          - command: "reload"
            prompt:
              - "Proceed with reload\\? \\[confirm\\]"
            answer:
              - "\r"
        wait_for:
          - "result[0] contains Reload"
        retries: "{{ cmd_retries }}"
        interval: "{{ cmd_interval }}"
      ignore_errors: yes
      register: reload_cmd

    - name: Wait for switch to come back (SSH)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 60
        timeout: 900
      delegate_to: localhost

    - name: Show version after reload
      cisco.ios.ios_command:
        commands:
          - "show version"
      register: post_version

    - name: Debug version after reload
      debug:
        var: post_version.stdout_lines

    - name: Assert the version is as expected
      assert:
        that:
          - "'17.15.03' in (post_version.stdout_lines[0] | default(''))"
        fail_msg: "Upgrade failed: Version after reload is not 17.15.03"
        success_msg: "Upgrade succeeded to version 17.15.03"
