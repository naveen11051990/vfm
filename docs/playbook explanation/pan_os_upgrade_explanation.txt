================================================================================
SIMPLE EXPLANATION: PAN-OS FIREWALL UPGRADE PROCESS
================================================================================

WHAT THIS AUTOMATION DOES:
This automation safely upgrades Palo Alto Networks firewalls from one software 
version to another, updating security content first, then upgrading the 
operating system through multiple versions if needed.

================================================================================
PART 1: INITIAL SETUP & VALIDATION
================================================================================

Step 1: Connection Setup
-------------------------
The automation connects to your firewall using:
- IP address (where the firewall lives on your network)
- Username and password (credentials to log in)
- No direct connection - it talks to the firewall remotely via API

Step 2: Required Input Check
-----------------------------
Before doing anything, it checks that you provided an "upgrade path" - this is 
a list of software versions the firewall needs to go through.

Example: If your firewall is on version 10.1.0 and you want 11.1.5, you might 
need to go through multiple steps:
  10.1.0 → 10.1.14 → 10.2.12 → 11.0.6 → 11.1.5

Why? Just like you can't upgrade Windows 7 directly to Windows 11, firewalls 
sometimes need intermediate versions.

If you forget to provide this upgrade path, the automation stops immediately 
and tells you what's missing.

================================================================================
PART 2: CONTENT UPDATE (SECURITY DEFINITIONS)
================================================================================

Think of this like updating your antivirus definitions before upgrading the 
antivirus software itself.

Step 1: Check Firewall Health
------------------------------
- Checks if the firewall is healthy and ready to work
- If not ready, waits 10 seconds and tries again
- Tries up to 10 times (total: about 100 seconds)
- If still not ready after 10 attempts, stops with an error

Step 2: Check for New Security Content
---------------------------------------
- Asks the firewall: "What's the latest security content available?"
- This is like checking for virus definition updates

Step 3: Download Latest Security Content
-----------------------------------------
- Tells the firewall: "Download the newest security definitions"
- The firewall starts downloading in the background
- Gets a "job ID" - a tracking number to check progress later

Step 4: Wait for Download to Finish
------------------------------------
- Every 10 seconds, checks: "Is the download done yet?"
- Keeps checking for up to 3000 seconds (50 minutes)
- If download fails, stops everything
- If download succeeds, moves to next step

Step 5: Install the Security Content
-------------------------------------
- Tells the firewall: "Install the security content you just downloaded"
- Again, gets a job ID to track this installation

Step 6: Wait for Installation to Complete
------------------------------------------
- Every 10 seconds, checks: "Is the installation done?"
- Keeps checking for up to 3000 seconds (50 minutes)
- Looks for two possible outcomes:
  * Installation finished successfully
  * Installation failed
- If it fails, stops everything

Step 7: Wait for Firewall to Stabilize
---------------------------------------
- After installing new content, the firewall needs a moment to process
- Checks every 15 seconds: "Are you ready now?"
- Tries up to 60 times (total: 15 minutes)
- Once ready, proceeds to operating system upgrade

================================================================================
PART 3: OPERATING SYSTEM UPGRADE (THE MAIN EVENT)
================================================================================

This happens ONCE FOR EACH VERSION in your upgrade path.

Example: If your path is ["10.1.14", "10.2.12", "11.0.6"], this whole section 
runs 3 times - once for each version.

--- For Each Target Version ---

Step 1: Download the Software Package
--------------------------------------
- Tells the firewall: "Download version X.X.X"
- If download fails:
  * Waits 60 seconds
  * Tries again
  * Does this up to 3 times total
- If all 3 attempts fail, stops everything
- If successful, moves to installation

Why 3 attempts? Networks can be flaky. Maybe the connection dropped or the 
firewall was temporarily busy.

Step 2: Install the Software (Without Restarting)
--------------------------------------------------
- Tells the firewall: "Install this version, but don't restart yet"
- This is like downloading and installing Windows updates but clicking 
  "Install later"
- The software is staged and ready, but not active yet

Step 3: Restart the Firewall
-----------------------------
- Sends the restart command to the firewall
- This happens "asynchronously" - meaning the automation doesn't wait for a 
  response
- The firewall begins shutting down immediately

Step 4: Wait for Firewall to Go Offline
----------------------------------------
- Tries to connect to port 443 (the firewall's web interface)
- Keeps trying until it can't connect anymore
- This confirms the firewall is actually restarting
- Waits up to 300 seconds (5 minutes)
- If it doesn't go offline, something's wrong - stops with error

Why check this? To confirm the restart actually happened. Sometimes commands 
fail silently.

Step 5: Wait for Firewall to Come Back Online
----------------------------------------------
- Now it waits for the OPPOSITE - for port 443 to respond again
- This means the firewall finished restarting
- Waits up to 900 seconds (15 minutes)
- If it doesn't come back, stops with error

Why 15 minutes? Firewalls take a while to boot up completely, especially when 
applying a major software upgrade.

Step 6: Wait for Firewall to Be Fully Ready
--------------------------------------------
- Just because port 443 responds doesn't mean the firewall is ready to use
- Keeps checking: "Are all your systems fully initialized?"
- Checks every 15 seconds
- Tries up to 100 times (total: 25 minutes)
- Once ready, moves to verification

Think of this like waiting for all your desktop icons to load after Windows 
starts - the computer booted, but it's not quite ready to use yet.

Step 7: Ask the Firewall What Version It's Running
---------------------------------------------------
- Queries the firewall: "What software version are you running now?"
- Gets back system information including the version number

Step 8: Verify the Upgrade Worked
----------------------------------
- Compares what the firewall reports vs. what we expected
- Expected: The version we just tried to install
- Actual: What the firewall says it's running
- If they DON'T match → something went wrong, stop everything
- If they DO match → success! Move to next version (if any)

Why verify? Software upgrades can fail in weird ways. The install might report 
success but actually fail. Always verify.

--- End of Loop - Repeat for Next Version ---

If there are more versions in the upgrade path, the entire process above 
repeats for the next version.

================================================================================
PART 4: FINAL VERIFICATION
================================================================================

After ALL versions have been installed:

Step 1: Get Final System Information
-------------------------------------
- Asks the firewall one more time: "What's your current version?"
- Collects complete system facts

Step 2: Display Success Message
--------------------------------
- Shows a message: "Upgrade complete. Final PAN-OS version: X.X.X"
- This confirms the entire upgrade process finished successfully

================================================================================
IMPORTANT SAFETY FEATURES
================================================================================

Retry Logic
-----------
Many steps retry automatically if they fail:
- Device readiness: retries 10-100 times depending on the stage
- Software download: retries 3 times with 60-second delays
- Job completion checks: retry every 10-15 seconds for up to 50 minutes

This handles temporary network issues, firewall busy states, and normal 
processing delays.

Timeout Protection
------------------
Every wait operation has a maximum timeout:
- Device going offline: 5 minutes
- Device coming online: 15 minutes  
- Device becoming ready: 25 minutes
- Job completion: 50 minutes

If any timeout is exceeded, the automation stops immediately to prevent 
infinite waiting.

Validation at Every Step
-------------------------
- Checks device health before starting
- Verifies job completion for downloads and installs
- Confirms the device rebooted (goes offline then online)
- Validates the final version matches what was expected
- Stops immediately if any check fails

Silent Operation for Repeated Checks
-------------------------------------
Some checks happen many times (100+ for device readiness). These use "no_log" 
to prevent flooding the output with repetitive "checking..." messages.

================================================================================
WHAT COULD GO WRONG (AND HOW IT'S HANDLED)
================================================================================

Scenario 1: Forgot to Provide Upgrade Path
-------------------------------------------
- Stops immediately at the validation step
- Shows clear error message telling you what to provide

Scenario 2: Firewall Not Responding
------------------------------------
- Tries 10 times to connect
- Fails with clear error if device never responds

Scenario 3: Download or Installation Fails
-------------------------------------------
- Detects failure from job status
- Stops immediately
- No partial upgrades

Scenario 4: Firewall Doesn't Reboot
------------------------------------
- Waits 5 minutes for port to go offline
- If it never does, fails with timeout error

Scenario 5: Firewall Doesn't Come Back After Reboot
----------------------------------------------------
- Waits 15 minutes for port to come back online
- If it never does, fails with timeout error
- Prevents you from assuming success when firewall might be broken

Scenario 6: Wrong Version After Upgrade
----------------------------------------
- Checks actual version vs. expected version
- If mismatch, fails with clear error showing both versions
- Prevents silent failures

================================================================================
SUMMARY: THE COMPLETE FLOW
================================================================================

1. Validate you provided an upgrade path → STOP if missing
2. Check firewall is healthy → STOP if not ready after 10 tries
3. Update security content (download → wait → install → wait → ready check)
4. FOR EACH version in upgrade path:
   a. Download software (3 retry attempts)
   b. Install software (staged, not active)
   c. Restart firewall
   d. Wait for offline (confirms restart started)
   e. Wait for online (confirms restart finished)
   f. Wait for full readiness (confirms firewall operational)
   g. Verify version matches expectation
   h. Repeat for next version
5. Get final system info
6. Display success message with final version

At ANY point where a check fails or a timeout is exceeded, the entire process 
stops with a clear error message.

================================================================================
WHY THIS APPROACH?
================================================================================

Staged Upgrades
---------------
Firewalls can't always jump directly to the latest version. They need 
intermediate versions to migrate configuration and data structures safely.

Content First, OS Second
-------------------------
Security content should always be current before upgrading the OS. This ensures 
maximum protection during the transition.

Verify Everything
-----------------
Never assume success. Check, verify, and confirm at every step. Firewalls are 
critical security infrastructure - silent failures are unacceptable.

Handle Real-World Issues
-------------------------
Networks drop, firewalls get busy, reboots take time. Retry logic and generous 
timeouts handle these normal operational realities.

================================================================================
END OF EXPLANATION
================================================================================
