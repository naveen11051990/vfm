---
- name: Full Cisco 9300 Upgrade via TFTP (Mgmt-vrf)
  hosts: 192.168.29.164
  gather_facts: no
  connection: network_cli
  collections:
    - cisco.ios

  tasks:
    - name: Ping TFTP server via Mgmt-vrf
      cisco.ios.ios_command:
        commands:
          - "ping vrf Mgmt-vrf 192.168.29.208"

    - name: Copy image from TFTP to flash using Mgmt-vrf
      cisco.ios.ios_command:
        commands:
          - command: "copy tftp://192.168.29.208/cat9k_iosxe.17.15.03.SPA.bin flash:cat9k_iosxe.17.15.03.SPA.bin vrf Mgmt-vrf"
            prompt: "Destination filename"
            answer: "cat9k_iosxe.17.15.03.SPA.bin"
            timeout: 600
      register: copy_output

    - name: Show copy output
      debug:
        var: copy_output.stdout_lines

    - name: Verify image exists in flash
      cisco.ios.ios_command:
        commands:
          - "dir flash:cat9k_iosxe.17.15.03.SPA.bin"
      register: dir_output

    - name: Show dir result
      debug:
        var: dir_output.stdout_lines

    - name: Configure boot variable to new image
      cisco.ios.ios_config:
        lines:
          - no boot system
          - "boot system flash:cat9k_iosxe.17.15.03.SPA.bin"

    - name: Save running-config
      cisco.ios.ios_command:
        commands:
          - write memory

    - name: Reload device
      cisco.ios.ios_command:
        commands:
          - command: "reload"
            prompt: "Proceed with reload"
            answer: "y"
      async: 1
      poll: 0

    - name: Wait for device to become reachable after reload
      wait_for_connection:
        timeout: 600
        delay: 10

    - name: Verify device is back (show version)
      cisco.ios.ios_command:
        commands:
          - "show version"
      register: boot_output

    - name: Show boot verification
      debug:
        var: boot_output.stdout_lines
