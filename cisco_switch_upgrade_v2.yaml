---
- name: Full Cisco 9300 Upgrade via TFTP (Mgmt-vrf)
  # hosts: "{{ target_host | default('192.168.29.164') }}"
  hosts: 192.168.29.164
  gather_facts: no
  connection: network_cli
  collections:
    - cisco.ios

  tasks:
    - name: Ping TFTP server via Mgmt-vrf
      cisco.ios.ios_command:
        commands:
          - "ping vrf Mgmt-vrf 192.168.29.208"

    - name: Copy image from TFTP to flash using Mgmt-vrf
      cisco.ios.ios_command:
        commands:
          - command: "copy tftp://192.168.29.208/cat9k_iosxe.17.15.04.SPA.bin flash:cat9k_iosxe.17.15.04.SPA.bin vrf Mgmt-vrf"
            prompt: "Destination filename"
            answer: "cat9k_iosxe.17.15.04.SPA.bin"
      register: copy_output
      vars:
        ansible_command_timeout: 600

    - name: Show copy output
      debug:
        var: copy_output.stdout_lines

    - name: Verify image exists in flash
      cisco.ios.ios_command:
        commands:
          - "dir flash:cat9k_iosxe.17.15.04.SPA.bin"
      register: dir_output

    - name: Show dir result
      debug:
        var: dir_output.stdout_lines

    - name: Convert to install mode
      cisco.ios.ios_command:
        commands:
          - command: "install add file flash:cat9k_iosxe.17.15.04.SPA.bin"
            prompt: "Proceed with reload"
            answer: "y"
      register: install_output
      vars:
        ansible_command_timeout: 1200

    - name: Show install output
      debug:
        var: install_output.stdout_lines

    - name: Check and set configuration register to 0x2102
      cisco.ios.ios_config:
        lines:
          - "config-register 0x2102"

    - name: Save running-config
      cisco.ios.ios_command:
        commands:
          - write memory
      vars:
        ansible_command_timeout: 60

    - name: Backup running config before reload
      cisco.ios.ios_command:
        commands:
          - "show running-config"
      register: config_backup

    - name: Reload device
      cisco.ios.ios_command:
        commands:
          - command: "reload"
            prompt: "Proceed with reload"
            answer: "y"
      async: 1
      poll: 0

    - name: Wait for device to become reachable after reload
      wait_for_connection:
        timeout: 900
        delay: 30
        sleep: 5

    - name: Verify device is back (show version)
      cisco.ios.ios_command:
        commands:
          - "show version"
      register: boot_output

    - name: Show boot verification
      debug:
        var: boot_output.stdout_lines
